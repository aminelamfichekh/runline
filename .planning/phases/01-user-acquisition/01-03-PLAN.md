---
phase: 01-user-acquisition
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - emrun-frontend/package.json
  - emrun-frontend/app.config.js
  - emrun-frontend/src/services/payment.service.ts
  - emrun-frontend/app/(subscription)/pricing.tsx
  - emrun-frontend/app/(subscription)/checkout.tsx
  - emrun-frontend/app/(subscription)/success.tsx
  - emrun-frontend/app/(subscription)/_layout.tsx
  - emrun-frontend/src/i18n/locales/fr.json
  - emrun-backend/app/Http/Controllers/Api/SubscriptionController.php
  - emrun-backend/app/Http/Controllers/Api/WebhookController.php
  - emrun-backend/routes/api.php
  - emrun-backend/config/services.php
autonomous: false

user_setup:
  - service: stripe
    why: "Payment processing for subscriptions"
    env_vars:
      - name: STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key"
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> Signing secret"
    dashboard_config:
      - task: "Create product and price for subscription"
        location: "Stripe Dashboard -> Products -> Add product"
      - task: "Create webhook endpoint pointing to /api/webhook/stripe"
        location: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint"

must_haves:
  truths:
    - "User can view subscription pricing after plan preview"
    - "User can subscribe via Stripe PaymentSheet"
    - "Subscription status updates on successful payment (via webhook)"
    - "User cannot access AI plans without active subscription"
    - "Payment flow works on both iOS and Android"
  artifacts:
    - path: "emrun-frontend/src/services/payment.service.ts"
      provides: "Stripe payment integration"
      exports: ["paymentService"]
    - path: "emrun-frontend/app/(subscription)/pricing.tsx"
      provides: "Subscription pricing display"
      contains: "price"
    - path: "emrun-frontend/app/(subscription)/checkout.tsx"
      provides: "Stripe PaymentSheet integration"
      contains: "presentPaymentSheet"
    - path: "emrun-backend/app/Http/Controllers/Api/WebhookController.php"
      provides: "Stripe webhook handler"
      contains: "stripe.webhooks.constructEvent"
  key_links:
    - from: "emrun-frontend/app/(subscription)/checkout.tsx"
      to: "/api/payment/create-subscription"
      via: "fetch payment intent"
      pattern: "create-subscription|createPaymentIntent"
    - from: "emrun-backend/app/Http/Controllers/Api/WebhookController.php"
      to: "User.subscriptionStatus"
      via: "webhook event handling"
      pattern: "subscription.*active|updateSubscription"
---

<objective>
Implement Stripe subscription payment flow with PaymentSheet and webhook handling.

Purpose: Convert registered users into paying subscribers. Stripe PaymentSheet provides a polished, native payment experience with Apple Pay / Google Pay support.

Output: Complete subscription flow from pricing display through payment to subscription activation via webhook.
</objective>

<execution_context>
@C:\Users\dell\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dell\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-user-acquisition/01-RESEARCH.md

# Prior plan summaries (if they exist)
@.planning/phases/01-user-acquisition/01-01-SUMMARY.md
@.planning/phases/01-user-acquisition/01-02-SUMMARY.md

# Existing files
@emrun-frontend/package.json
@emrun-frontend/app.config.js
@emrun-backend/app/Http/Controllers/Api/SubscriptionController.php
@emrun-backend/app/Http/Controllers/Api/WebhookController.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Stripe SDK and configure frontend</name>
  <files>
    emrun-frontend/package.json
    emrun-frontend/app.config.js
    emrun-frontend/src/services/payment.service.ts
    emrun-frontend/app/_layout.tsx
  </files>
  <action>
Install Stripe React Native SDK:
```bash
cd emrun-frontend && npm install @stripe/stripe-react-native
```

Update app.config.js for Stripe:
```javascript
export default {
  // ... existing config
  plugins: [
    // ... existing plugins
    [
      '@stripe/stripe-react-native',
      {
        merchantIdentifier: 'merchant.com.runline.app',
        enableGooglePay: true
      }
    ]
  ]
};
```

Create payment service (`src/services/payment.service.ts`):
```typescript
import { api } from './api';

export const paymentService = {
  // Get subscription plans/prices
  async getPlans() {
    const response = await api.get('/subscription/plans');
    return response.data;
  },

  // Create subscription (returns clientSecret for PaymentSheet)
  async createSubscription(priceId: string) {
    const response = await api.post('/payment/create-subscription', { priceId });
    return response.data; // { clientSecret, subscriptionId, ephemeralKey, customerId }
  },

  // Get current subscription status
  async getSubscriptionStatus() {
    const response = await api.get('/subscription/status');
    return response.data;
  },

  // Cancel subscription
  async cancelSubscription() {
    const response = await api.post('/subscription/cancel');
    return response.data;
  }
};
```

Update root layout (`app/_layout.tsx`) to wrap app in StripeProvider:
```typescript
import { StripeProvider } from '@stripe/stripe-react-native';

const STRIPE_PUBLISHABLE_KEY = process.env.EXPO_PUBLIC_STRIPE_PUBLISHABLE_KEY;

export default function RootLayout() {
  return (
    <StripeProvider
      publishableKey={STRIPE_PUBLISHABLE_KEY}
      merchantIdentifier="merchant.com.runline.app"
    >
      <AuthProvider>
        {/* rest of app */}
      </AuthProvider>
    </StripeProvider>
  );
}
```

Create .env entries (document in README):
```
EXPO_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
EXPO_PUBLIC_API_URL=http://localhost:8000/api
```
  </action>
  <verify>
- `npm ls @stripe/stripe-react-native` shows installed
- File `src/services/payment.service.ts` exists
- app.config.js includes Stripe plugin configuration
- No build errors: `npx expo start`
  </verify>
  <done>
Stripe SDK installed and configured. Payment service created. StripeProvider wrapping app.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create subscription screens (pricing, checkout, success)</name>
  <files>
    emrun-frontend/app/(subscription)/_layout.tsx
    emrun-frontend/app/(subscription)/pricing.tsx
    emrun-frontend/app/(subscription)/checkout.tsx
    emrun-frontend/app/(subscription)/success.tsx
    emrun-frontend/src/i18n/locales/fr.json
  </files>
  <action>
Create subscription layout (`app/(subscription)/_layout.tsx`):
- Stack navigator for subscription flow
- Dark theme consistent with rest of app

Create pricing screen (`app/(subscription)/pricing.tsx`):
- Display subscription price (from backend or hardcoded for MVP)
- Show value proposition summary (based on questionnaire answers)
- Display pricing: "9.99 EUR/mois" or similar
- "S'abonner" button to proceed to checkout
- French localization for all text
- Dark theme styling

```typescript
function PricingScreen() {
  const { t } = useTranslation();
  const router = useRouter();
  const { answers } = useQuestionnaire();

  return (
    <SafeAreaView style={styles.container}>
      <Text style={styles.title}>{t('subscription.pricing.title')}</Text>

      {/* Value summary based on questionnaire */}
      <View style={styles.summaryCard}>
        <Text>{t('subscription.pricing.personalizedFor')}</Text>
        <Text>{answers.goal === 'race' ? t('goals.race') : t('goals.health')}</Text>
        <Text>{answers.weeklyVolume} km/semaine</Text>
      </View>

      {/* Price display */}
      <View style={styles.priceCard}>
        <Text style={styles.price}>9,99 EUR</Text>
        <Text style={styles.period}>/mois</Text>
      </View>

      {/* Features list */}
      <View style={styles.features}>
        <FeatureItem icon="check" text={t('subscription.features.personalizedPlan')} />
        <FeatureItem icon="check" text={t('subscription.features.monthlyRegeneration')} />
        <FeatureItem icon="check" text={t('subscription.features.adaptiveDifficulty')} />
      </View>

      <Button
        title={t('subscription.pricing.subscribe')}
        onPress={() => router.push('/(subscription)/checkout')}
      />
    </SafeAreaView>
  );
}
```

Create checkout screen (`app/(subscription)/checkout.tsx`):
- Use Stripe PaymentSheet for payment
- Flow:
  1. Call backend to create subscription (get clientSecret)
  2. Initialize PaymentSheet with clientSecret
  3. Present PaymentSheet
  4. Handle result (success/cancel/error)

```typescript
import { useStripe } from '@stripe/stripe-react-native';
import { paymentService } from '@/services/payment.service';

function CheckoutScreen() {
  const { initPaymentSheet, presentPaymentSheet } = useStripe();
  const [loading, setLoading] = useState(false);
  const router = useRouter();
  const { t } = useTranslation();

  const handlePayment = async () => {
    setLoading(true);
    try {
      // 1. Create subscription on backend
      const { clientSecret, ephemeralKey, customerId } =
        await paymentService.createSubscription('price_monthly');

      // 2. Initialize PaymentSheet
      const { error: initError } = await initPaymentSheet({
        merchantDisplayName: 'RUNLINE',
        paymentIntentClientSecret: clientSecret,
        customerEphemeralKeySecret: ephemeralKey,
        customerId: customerId,
        defaultBillingDetails: { name: 'Runner' },
        style: 'alwaysDark', // Match app theme
      });

      if (initError) {
        Alert.alert(t('subscription.errors.initFailed'), initError.message);
        return;
      }

      // 3. Present PaymentSheet
      const { error: paymentError } = await presentPaymentSheet();

      if (paymentError) {
        if (paymentError.code === 'Canceled') {
          // User canceled - do nothing
        } else {
          Alert.alert(t('subscription.errors.paymentFailed'), paymentError.message);
        }
      } else {
        // Payment successful - navigate to success
        router.replace('/(subscription)/success');
      }
    } catch (error) {
      Alert.alert(t('subscription.errors.error'), error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <SafeAreaView style={styles.container}>
      <Text style={styles.title}>{t('subscription.checkout.title')}</Text>
      <Text style={styles.subtitle}>{t('subscription.checkout.securePayment')}</Text>

      <Button
        title={loading ? t('common.loading') : t('subscription.checkout.pay')}
        onPress={handlePayment}
        disabled={loading}
      />
    </SafeAreaView>
  );
}
```

Create success screen (`app/(subscription)/success.tsx`):
- Celebration/confirmation UI
- "Your plan is being generated" message
- Navigate to dashboard/home button
- Handle case where plan generation is async (user will be notified)

Add French translations to fr.json:
```json
{
  "subscription": {
    "pricing": {
      "title": "Votre plan personnalise",
      "personalizedFor": "Adapte a vos objectifs",
      "subscribe": "S'abonner - 9,99 EUR/mois",
      "features": {
        "personalizedPlan": "Plan d'entrainement personnalise",
        "monthlyRegeneration": "Regeneration mensuelle automatique",
        "adaptiveDifficulty": "Difficulte adaptee a votre niveau"
      }
    },
    "checkout": {
      "title": "Paiement",
      "securePayment": "Paiement securise par Stripe",
      "pay": "Payer 9,99 EUR"
    },
    "success": {
      "title": "Bienvenue!",
      "message": "Votre abonnement est actif. Votre plan d'entrainement est en cours de generation.",
      "continue": "Acceder a mon tableau de bord"
    },
    "errors": {
      "initFailed": "Erreur d'initialisation",
      "paymentFailed": "Paiement echoue",
      "error": "Erreur"
    }
  }
}
```
  </action>
  <verify>
- All subscription screens exist in `app/(subscription)/`
- Navigate through flow: pricing -> checkout -> (payment) -> success
- All text displays in French
- No TypeScript errors
  </verify>
  <done>
Subscription screens created with Stripe PaymentSheet integration and French localization.
  </done>
</task>

<task type="auto">
  <name>Task 3: Backend subscription and webhook handling</name>
  <files>
    emrun-backend/app/Http/Controllers/Api/SubscriptionController.php
    emrun-backend/app/Http/Controllers/Api/WebhookController.php
    emrun-backend/routes/api.php
    emrun-backend/config/services.php
    emrun-backend/.env
  </files>
  <action>
Update SubscriptionController (`app/Http/Controllers/Api/SubscriptionController.php`):

Add method to create subscription:
```php
public function createSubscription(Request $request)
{
    $user = $request->user();
    $priceId = $request->input('priceId', config('services.stripe.default_price_id'));

    $stripe = new \Stripe\StripeClient(config('services.stripe.secret'));

    // Get or create Stripe customer
    if (!$user->stripe_customer_id) {
        $customer = $stripe->customers->create([
            'email' => $user->email,
            'metadata' => ['user_id' => $user->id]
        ]);
        $user->stripe_customer_id = $customer->id;
        $user->save();
    }

    // Create ephemeral key for PaymentSheet
    $ephemeralKey = $stripe->ephemeralKeys->create(
        ['customer' => $user->stripe_customer_id],
        ['stripe_version' => '2023-10-16']
    );

    // Create subscription with payment
    $subscription = $stripe->subscriptions->create([
        'customer' => $user->stripe_customer_id,
        'items' => [['price' => $priceId]],
        'payment_behavior' => 'default_incomplete',
        'payment_settings' => ['save_default_payment_method' => 'on_subscription'],
        'expand' => ['latest_invoice.payment_intent'],
    ]);

    return response()->json([
        'subscriptionId' => $subscription->id,
        'clientSecret' => $subscription->latest_invoice->payment_intent->client_secret,
        'ephemeralKey' => $ephemeralKey->secret,
        'customerId' => $user->stripe_customer_id,
    ]);
}

public function getStatus(Request $request)
{
    $user = $request->user();
    return response()->json([
        'status' => $user->subscription_status ?? 'inactive',
        'ends_at' => $user->subscription_ends_at,
    ]);
}
```

Update WebhookController (`app/Http/Controllers/Api/WebhookController.php`):

CRITICAL: Use raw request body for signature verification:
```php
public function handleStripeWebhook(Request $request)
{
    $payload = $request->getContent();
    $sigHeader = $request->header('Stripe-Signature');
    $webhookSecret = config('services.stripe.webhook_secret');

    try {
        $event = \Stripe\Webhook::constructEvent(
            $payload, $sigHeader, $webhookSecret
        );
    } catch (\Exception $e) {
        Log::error('Stripe webhook signature verification failed: ' . $e->getMessage());
        return response()->json(['error' => 'Invalid signature'], 400);
    }

    // Handle subscription events
    switch ($event->type) {
        case 'customer.subscription.created':
        case 'customer.subscription.updated':
            $subscription = $event->data->object;
            $this->updateUserSubscription($subscription);
            break;

        case 'customer.subscription.deleted':
            $subscription = $event->data->object;
            $this->cancelUserSubscription($subscription);
            break;

        case 'invoice.paid':
            $invoice = $event->data->object;
            $this->recordPayment($invoice);
            break;

        case 'invoice.payment_failed':
            $invoice = $event->data->object;
            $this->handlePaymentFailure($invoice);
            break;
    }

    return response()->json(['received' => true]);
}

private function updateUserSubscription($subscription)
{
    $user = User::where('stripe_customer_id', $subscription->customer)->first();
    if ($user) {
        $user->subscription_status = $subscription->status;
        $user->subscription_id = $subscription->id;
        $user->subscription_ends_at = Carbon::createFromTimestamp($subscription->current_period_end);
        $user->save();
    }
}

private function cancelUserSubscription($subscription)
{
    $user = User::where('stripe_customer_id', $subscription->customer)->first();
    if ($user) {
        $user->subscription_status = 'canceled';
        $user->save();
    }
}
```

Update routes (`routes/api.php`):
```php
// Public webhook route (no auth)
Route::post('/webhook/stripe', [WebhookController::class, 'handleStripeWebhook'])
    ->withoutMiddleware(['auth:api']); // No auth for webhooks

// Protected subscription routes
Route::middleware('auth:api')->group(function () {
    Route::post('/payment/create-subscription', [SubscriptionController::class, 'createSubscription']);
    Route::get('/subscription/status', [SubscriptionController::class, 'getStatus']);
    Route::post('/subscription/cancel', [SubscriptionController::class, 'cancel']);
});
```

Add middleware to protect AI plan access:
```php
// In routes or controller
Route::middleware(['auth:api', 'subscription'])->group(function () {
    Route::get('/plans', [PlanController::class, 'index']);
    Route::get('/plans/current', [PlanController::class, 'current']);
});

// Create SubscriptionMiddleware
class SubscriptionMiddleware
{
    public function handle($request, $next)
    {
        if ($request->user()->subscription_status !== 'active') {
            return response()->json(['error' => 'Subscription required'], 403);
        }
        return $next($request);
    }
}
```

Update config/services.php:
```php
'stripe' => [
    'key' => env('STRIPE_KEY'),
    'secret' => env('STRIPE_SECRET'),
    'webhook_secret' => env('STRIPE_WEBHOOK_SECRET'),
    'default_price_id' => env('STRIPE_DEFAULT_PRICE_ID'),
],
```

Document required .env variables:
```
STRIPE_KEY=pk_test_...
STRIPE_SECRET=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_DEFAULT_PRICE_ID=price_...
```
  </action>
  <verify>
Test with Stripe CLI:
```bash
# Listen to webhooks locally
stripe listen --forward-to localhost:8000/api/webhook/stripe

# Trigger test events
stripe trigger customer.subscription.created
stripe trigger invoice.paid
```

Test subscription creation:
```bash
curl -X POST http://localhost:8000/api/payment/create-subscription \
  -H "Authorization: Bearer ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"priceId":"price_xxx"}'

# Should return clientSecret, ephemeralKey, customerId
```

Verify subscription protection:
```bash
curl http://localhost:8000/api/plans \
  -H "Authorization: Bearer ACCESS_TOKEN"

# Should return 403 if no active subscription
```
  </verify>
  <done>
Backend subscription creation and Stripe webhook handling complete. AI plan routes protected by subscription middleware.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Stripe subscription flow:
- Frontend: Pricing screen, Checkout with PaymentSheet, Success screen
- Backend: Subscription creation, Webhook handling, Subscription protection middleware
  </what-built>
  <how-to-verify>
1. Start the app: `cd emrun-frontend && npx expo start`
2. Start backend: `cd emrun-backend && php artisan serve`
3. Start Stripe webhook forwarding: `stripe listen --forward-to localhost:8000/api/webhook/stripe`
4. Complete questionnaire flow
5. Proceed to pricing screen - verify French text and pricing displayed
6. Tap "S'abonner" - PaymentSheet should appear
7. Use Stripe test card: 4242 4242 4242 4242, any future date, any CVC
8. Complete payment
9. Verify redirected to success screen
10. Check database: user should have subscription_status = 'active'
11. Try accessing /plans endpoint - should work now (was 403 before)
  </how-to-verify>
  <resume-signal>Type "approved" if payment flow works, or describe issues encountered</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **End-to-end flow test**:
   - Complete questionnaire anonymously
   - See plan preview
   - View pricing
   - Register account (session transfers)
   - Complete Stripe payment
   - Verify subscription active

2. **Webhook verification**:
   - Check Stripe dashboard for successful webhook deliveries
   - Verify user.subscription_status updated in database

3. **Subscription protection test**:
   - Try accessing /api/plans without subscription -> 403
   - Complete subscription -> 200

4. **Platform test**:
   - Test on iOS simulator/device
   - Test on Android emulator/device
   - PaymentSheet should adapt to each platform
</verification>

<success_criteria>
- User sees subscription pricing after plan preview
- User completes payment via Stripe PaymentSheet
- Stripe webhooks update user subscription status
- User with active subscription can access AI plans
- User without subscription gets 403 on protected routes
- Payment flow works on both iOS and Android
- All subscription UI displays in French
</success_criteria>

<output>
After completion, create `.planning/phases/01-user-acquisition/01-03-SUMMARY.md`
</output>
