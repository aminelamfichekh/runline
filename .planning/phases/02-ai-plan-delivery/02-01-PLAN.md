---
phase: 02-ai-plan-delivery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - emrun-backend/app/Jobs/GeneratePlanJob.php
  - emrun-backend/app/Services/PlanGeneratorService.php
  - emrun-backend/app/Http/Controllers/Api/WebhookController.php
  - emrun-backend/app/Console/Commands/GenerateMonthlyPlans.php
  - emrun-backend/routes/console.php
autonomous: true

user_setup:
  - service: openai
    why: "AI plan generation"
    env_vars:
      - name: OPENAI_API_KEY
        source: "OpenAI Dashboard -> API keys"

must_haves:
  truths:
    - "Initial plan generates automatically after subscription payment"
    - "Plan generation uses OpenAI structured outputs with guaranteed valid JSON"
    - "Monthly regeneration runs automatically every first Monday"
    - "Failed plan generation retries automatically (3 attempts)"
  artifacts:
    - path: "emrun-backend/app/Jobs/GeneratePlanJob.php"
      provides: "OpenAI structured output plan generation"
      contains: "response_format"
    - path: "emrun-backend/app/Http/Controllers/Api/WebhookController.php"
      provides: "Subscription webhook triggers plan generation"
      contains: "generateInitialPlan"
    - path: "emrun-backend/app/Console/Commands/GenerateMonthlyPlans.php"
      provides: "Monthly regeneration command"
      contains: "generateMonthlyPlan"
  key_links:
    - from: "WebhookController.php"
      to: "PlanGeneratorService"
      via: "subscription.created triggers generateInitialPlan"
      pattern: "generateInitialPlan"
    - from: "GeneratePlanJob.php"
      to: "OpenAI API"
      via: "json_schema structured outputs"
      pattern: "json_schema"
---

<objective>
Implement backend AI plan generation with OpenAI structured outputs, subscription webhook trigger, and monthly cron job.

Purpose: Enable automatic plan generation when users subscribe and monthly regeneration for ongoing engagement.
Output: Working backend that generates valid JSON training plans via OpenAI when triggered by subscription or cron.
</objective>

<execution_context>
@C:\Users\dell\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dell\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ai-plan-delivery/02-RESEARCH.md
@emrun-backend/app/Jobs/GeneratePlanJob.php
@emrun-backend/app/Services/PlanGeneratorService.php
@emrun-backend/app/Http/Controllers/Api/WebhookController.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade GeneratePlanJob to use OpenAI structured outputs</name>
  <files>
    emrun-backend/app/Jobs/GeneratePlanJob.php
    emrun-backend/app/Services/PlanGeneratorService.php
  </files>
  <action>
Update GeneratePlanJob.php to use OpenAI structured outputs with json_schema:

1. Change model from 'gpt-4' to 'gpt-4o-2024-08-06' (supports structured outputs)

2. Add response_format with json_schema to the chat create call:
```php
'response_format' => [
    'type' => 'json_schema',
    'json_schema' => [
        'name' => 'training_plan',
        'strict' => true,
        'schema' => $this->getPlanSchema()
    ]
]
```

3. Add getPlanSchema() method returning the schema from 02-RESEARCH.md (plan_summary, total_weeks, weeks array with days containing workout objects)

4. Update PlanGeneratorService.php buildPrompt() methods to:
   - Add explicit week structure calculation in prompt (number of weeks, each week's dates)
   - Add clear French-language instructions for content generation
   - Include workout types enum (endurance, vma, seuil, fractionne, recuperation, sortie_longue)

5. Remove the fallback to raw_content since structured outputs guarantee valid JSON

The existing job retry mechanism ($tries = 3, $backoff = 60) is already correct - keep it.
  </action>
  <verify>
Run `php artisan tinker` and test:
```php
$user = User::first();
$plan = Plan::create(['user_id' => $user->id, 'start_date' => now()->next('Monday'), 'end_date' => now()->addMonth()->endOfMonth(), 'type' => 'initial', 'status' => 'pending', 'content' => []]);
dispatch(new \App\Jobs\GeneratePlanJob($plan, 'initial'));
```
Check plan content is valid JSON with weeks array after job completes.
  </verify>
  <done>
GeneratePlanJob uses gpt-4o with json_schema structured outputs.
Plan content is guaranteed valid JSON with weeks/days/workouts structure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add plan generation trigger to subscription webhook</name>
  <files>
    emrun-backend/app/Http/Controllers/Api/WebhookController.php
  </files>
  <action>
Update WebhookController.php to trigger initial plan generation when subscription is created:

1. Import PlanGeneratorService at top of file

2. Add PlanGeneratorService to constructor injection

3. In the 'customer.subscription.created' case, after calling handleSubscriptionCreated(), add:
```php
// Trigger initial plan generation if questionnaire completed
$user = $subscription->user;
if ($user->profile && $user->profile->questionnaire_completed) {
    // Check if initial plan already exists to prevent duplicates
    $existingPlan = \App\Models\Plan::where('user_id', $user->id)
        ->where('type', 'initial')
        ->first();

    if (!$existingPlan) {
        $this->planGeneratorService->generateInitialPlan($user);
        Log::info('Initial plan generation triggered for new subscriber', [
            'user_id' => $user->id,
        ]);
    }
}
```

This uses the existing PlanGeneratorService::generateInitialPlan() which dispatches GeneratePlanJob asynchronously.
  </action>
  <verify>
Grep the file for generateInitialPlan to confirm it's called in webhook handler:
`grep -n "generateInitialPlan" emrun-backend/app/Http/Controllers/Api/WebhookController.php`

Check no syntax errors: `php -l emrun-backend/app/Http/Controllers/Api/WebhookController.php`
  </verify>
  <done>
Stripe subscription.created webhook triggers initial plan generation.
Duplicate plan creation is prevented by checking for existing initial plan.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create monthly plan regeneration cron command</name>
  <files>
    emrun-backend/app/Console/Commands/GenerateMonthlyPlans.php
    emrun-backend/routes/console.php
  </files>
  <action>
1. Create GenerateMonthlyPlans.php command:
```php
<?php

namespace App\Console\Commands;

use App\Models\User;
use App\Services\PlanGeneratorService;
use Carbon\Carbon;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\Log;

class GenerateMonthlyPlans extends Command
{
    protected $signature = 'plans:generate-monthly';
    protected $description = 'Generate monthly training plans for all active subscribers';

    public function handle(PlanGeneratorService $planGeneratorService): int
    {
        $today = Carbon::today();

        // Only run on first Monday of the month
        if (!$this->isFirstMondayOfMonth($today)) {
            $this->info('Not first Monday of month, skipping.');
            return Command::SUCCESS;
        }

        $this->info('Generating monthly plans for active subscribers...');

        // Get all users with active subscriptions and completed questionnaires
        $users = User::whereHas('subscription', function ($query) {
            $query->where('status', 'active');
        })->whereHas('profile', function ($query) {
            $query->where('questionnaire_completed', true);
        })->get();

        $generated = 0;
        $skipped = 0;
        $failed = 0;

        foreach ($users as $user) {
            try {
                $planGeneratorService->generateMonthlyPlan($user);
                $generated++;
                $this->info("Generated plan for user {$user->id}");
            } catch (\Exception $e) {
                if (str_contains($e->getMessage(), 'already exists')) {
                    $skipped++;
                    $this->warn("Skipped user {$user->id}: plan already exists");
                } else {
                    $failed++;
                    $this->error("Failed for user {$user->id}: {$e->getMessage()}");
                    Log::error('Monthly plan generation failed', [
                        'user_id' => $user->id,
                        'error' => $e->getMessage(),
                    ]);
                }
            }
        }

        $this->info("Complete: {$generated} generated, {$skipped} skipped, {$failed} failed");

        return $failed > 0 ? Command::FAILURE : Command::SUCCESS;
    }

    private function isFirstMondayOfMonth(Carbon $date): bool
    {
        if ($date->dayOfWeek !== Carbon::MONDAY) {
            return false;
        }
        return $date->day <= 7;
    }
}
```

2. Add schedule to routes/console.php:
```php
use Illuminate\Support\Facades\Schedule;

Schedule::command('plans:generate-monthly')->dailyAt('06:00');
```

The command checks if it's the first Monday before running, so daily schedule is safe.
  </action>
  <verify>
Test the command exists: `php artisan list | grep plans:generate`

Test it runs (will skip if not first Monday): `php artisan plans:generate-monthly`

Check no syntax errors: `php -l emrun-backend/app/Console/Commands/GenerateMonthlyPlans.php`
  </verify>
  <done>
Monthly regeneration command exists and is scheduled daily at 06:00.
Command only generates plans on first Monday of month.
Handles existing plans gracefully (skips duplicates).
  </done>
</task>

</tasks>

<verification>
1. Backend syntax check: `cd emrun-backend && php artisan route:list` completes without errors
2. GeneratePlanJob uses structured outputs: grep for 'json_schema' in GeneratePlanJob.php
3. Webhook triggers plan: grep for 'generateInitialPlan' in WebhookController.php
4. Cron command exists: `php artisan plans:generate-monthly --help` shows command
5. No duplicate plan logic: grep for 'already exists' or existing plan check in both webhook and cron
</verification>

<success_criteria>
- GeneratePlanJob uses gpt-4o-2024-08-06 with json_schema response_format
- WebhookController triggers generateInitialPlan on subscription.created
- GenerateMonthlyPlans command runs on first Monday schedule
- All PHP files pass syntax check (`php -l`)
- Job retry mechanism preserved ($tries = 3, $backoff = 60)
</success_criteria>

<output>
After completion, create `.planning/phases/02-ai-plan-delivery/02-01-SUMMARY.md`
</output>
