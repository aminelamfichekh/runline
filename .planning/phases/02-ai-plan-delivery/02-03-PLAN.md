---
phase: 02-ai-plan-delivery
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - emrun-frontend/src/services/plan.service.ts
  - emrun-frontend/src/hooks/usePlan.ts
  - emrun-frontend/types/plan.ts
  - emrun-frontend/app/(tabs)/plans.tsx
  - emrun-frontend/app/(plans)/week/[weekNumber].tsx
  - emrun-frontend/app/(plans)/day/[dayId].tsx
autonomous: false

must_haves:
  truths:
    - "User can view current training plan in Mes Plans page"
    - "Plan displays weekly breakdown with daily workouts"
    - "Plan shows in French (AI generates French content)"
    - "User can view plan history (all previous months)"
    - "Loading states show while plan is generating"
  artifacts:
    - path: "emrun-frontend/src/services/plan.service.ts"
      provides: "API calls to plan endpoints"
      contains: "getActivePlan"
    - path: "emrun-frontend/src/hooks/usePlan.ts"
      provides: "React hook for plan data"
      contains: "useActivePlan"
    - path: "emrun-frontend/app/(tabs)/plans.tsx"
      provides: "Week overview with real data"
      contains: "usePlan"
  key_links:
    - from: "plans.tsx"
      to: "/api/plans/active"
      via: "usePlan hook"
      pattern: "useActivePlan"
    - from: "week/[weekNumber].tsx"
      to: "plan.content.weeks"
      via: "week data from plan"
      pattern: "plan\\.content\\.weeks"
---

<objective>
Connect frontend plan screens to real backend API data, replacing mock data with AI-generated plans.

Purpose: Display real training plans to users with proper loading states and plan history.
Output: Working plan display showing AI-generated weekly workouts in French.
</objective>

<execution_context>
@C:\Users\dell\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dell\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ai-plan-delivery/02-RESEARCH.md
@.planning/phases/02-ai-plan-delivery/02-01-SUMMARY.md
@emrun-frontend/app/(tabs)/plans.tsx
@emrun-frontend/app/(plans)/week/[weekNumber].tsx
@emrun-frontend/app/(plans)/day/[dayId].tsx
@emrun-backend/app/Http/Controllers/Api/PlanController.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plan types and API service</name>
  <files>
    emrun-frontend/types/plan.ts
    emrun-frontend/src/services/plan.service.ts
    emrun-frontend/src/hooks/usePlan.ts
  </files>
  <action>
1. Create types/plan.ts with TypeScript interfaces matching backend JSON schema:
```typescript
export interface WorkoutStep {
  title: string;
  description: string;
  duration_minutes?: number;
}

export interface Workout {
  title: string;
  type: 'endurance' | 'vma' | 'seuil' | 'fractionne' | 'recuperation' | 'sortie_longue';
  duration_minutes: number;
  description: string;
  steps: WorkoutStep[];
}

export interface PlanDay {
  day_name: 'Lundi' | 'Mardi' | 'Mercredi' | 'Jeudi' | 'Vendredi' | 'Samedi' | 'Dimanche';
  date: string; // YYYY-MM-DD
  is_rest: boolean;
  workout: Workout | null;
}

export interface PlanWeek {
  week_number: number;
  start_date: string; // YYYY-MM-DD
  end_date: string; // YYYY-MM-DD
  week_focus: string;
  days: PlanDay[];
}

export interface PlanContent {
  plan_summary: string;
  total_weeks: number;
  weeks: PlanWeek[];
}

export interface Plan {
  id: number;
  user_id: number;
  start_date: string;
  end_date: string;
  type: 'initial' | 'monthly';
  status: 'pending' | 'generating' | 'completed' | 'failed';
  content: PlanContent | null;
  created_at: string;
  updated_at: string;
}
```

2. Create src/services/plan.service.ts:
```typescript
import { apiClient } from '@/lib/api/client';
import { Plan } from '@/types/plan';

export async function getActivePlan(): Promise<Plan | null> {
  const response = await apiClient.get<{ success: boolean; data: { plan: Plan | null } }>('/plans/active');
  return response.data.plan;
}

export async function getAllPlans(): Promise<Plan[]> {
  const response = await apiClient.get<{ success: boolean; data: { plans: Plan[] } }>('/plans');
  return response.data.plans;
}

export async function getPlan(id: number): Promise<Plan> {
  const response = await apiClient.get<{ success: boolean; data: { plan: Plan } }>(`/plans/${id}`);
  return response.data.plan;
}

export async function triggerPlanGeneration(type: 'initial' | 'monthly' = 'initial'): Promise<Plan> {
  const response = await apiClient.post<{ success: boolean; data: { plan: Plan } }>('/plans/generate', { type });
  return response.data.plan;
}
```

3. Create src/hooks/usePlan.ts:
```typescript
import { useState, useEffect, useCallback } from 'react';
import { Plan } from '@/types/plan';
import { getActivePlan, getAllPlans } from '@/src/services/plan.service';

export function useActivePlan() {
  const [plan, setPlan] = useState<Plan | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const fetchPlan = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const activePlan = await getActivePlan();
      setPlan(activePlan);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to fetch plan');
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchPlan();
  }, [fetchPlan]);

  return { plan, loading, error, refetch: fetchPlan };
}

export function usePlanHistory() {
  const [plans, setPlans] = useState<Plan[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const fetchPlans = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const allPlans = await getAllPlans();
      setPlans(allPlans);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to fetch plans');
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchPlans();
  }, [fetchPlans]);

  return { plans, loading, error, refetch: fetchPlans };
}
```
  </action>
  <verify>
Check files exist:
`ls emrun-frontend/types/plan.ts emrun-frontend/src/services/plan.service.ts emrun-frontend/src/hooks/usePlan.ts`

Check all files compile (run TypeScript check on all created files):
`cd emrun-frontend && npx tsc --noEmit types/plan.ts src/services/plan.service.ts src/hooks/usePlan.ts`
  </verify>
  <done>
Plan types match backend JSON schema.
plan.service.ts provides getActivePlan, getAllPlans, getPlan, triggerPlanGeneration.
usePlan.ts hook provides useActivePlan and usePlanHistory with loading/error states.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire plans.tsx to real API data</name>
  <files>
    emrun-frontend/app/(tabs)/plans.tsx
  </files>
  <action>
Replace mock data generation in plans.tsx with real API data:

1. Add imports at top:
```typescript
import { useActivePlan, usePlanHistory } from '@/src/hooks/usePlan';
import { ActivityIndicator } from 'react-native';
```

2. Replace generateWeeksForMonth() with API data:
- Remove the mock data generation function
- Use useActivePlan() hook to get current plan
- Map plan.content.weeks to the UI

3. Add loading and empty states:
```typescript
const { plan, loading, error } = useActivePlan();

if (loading) {
  return (
    <View style={[styles.container, { justifyContent: 'center', alignItems: 'center' }]}>
      <ActivityIndicator size="large" color={colors.accent.blue} />
      <Text style={styles.loadingText}>Chargement de votre plan...</Text>
    </View>
  );
}

if (!plan || !plan.content) {
  return (
    <View style={[styles.container, { justifyContent: 'center', alignItems: 'center' }]}>
      <Ionicons name="calendar-outline" size={64} color={colors.text.tertiary} />
      <Text style={styles.emptyTitle}>Aucun plan actif</Text>
      <Text style={styles.emptySubtitle}>Votre plan sera genere apres votre abonnement.</Text>
    </View>
  );
}

// Plan is generating
if (plan.status === 'generating' || plan.status === 'pending') {
  return (
    <View style={[styles.container, { justifyContent: 'center', alignItems: 'center' }]}>
      <ActivityIndicator size="large" color={colors.accent.blue} />
      <Text style={styles.loadingText}>Generation de votre plan en cours...</Text>
      <Text style={styles.loadingSubtext}>Vous recevrez une notification des qu'il sera pret.</Text>
    </View>
  );
}
```

4. Map weeks from plan.content.weeks instead of mock data:
```typescript
const weeks = plan.content.weeks.map((week) => ({
  weekNumber: week.week_number,
  startDay: parseInt(week.start_date.split('-')[2]),
  endDay: parseInt(week.end_date.split('-')[2]),
  status: getWeekStatus(week),
  sessionsCount: week.days.filter(d => !d.is_rest).length,
  completedSessions: 0, // Phase 3 will add tracking
  weekFocus: week.week_focus,
}));
```

5. Add helper function getWeekStatus():
```typescript
const getWeekStatus = (week: PlanWeek): 'completed' | 'in_progress' | 'upcoming' => {
  const today = new Date().toISOString().split('T')[0];
  if (week.end_date < today) return 'completed';
  if (week.start_date <= today && today <= week.end_date) return 'in_progress';
  return 'upcoming';
};
```

6. Add styles for loading/empty states:
```typescript
loadingText: {
  fontSize: 16,
  color: colors.text.secondary,
  marginTop: 16,
},
loadingSubtext: {
  fontSize: 14,
  color: colors.text.tertiary,
  marginTop: 8,
  textAlign: 'center',
  paddingHorizontal: 32,
},
emptyTitle: {
  fontSize: 20,
  fontWeight: '700',
  color: colors.text.primary,
  marginTop: 16,
},
emptySubtitle: {
  fontSize: 14,
  color: colors.text.tertiary,
  marginTop: 8,
  textAlign: 'center',
  paddingHorizontal: 32,
},
```
  </action>
  <verify>
Check plans.tsx imports usePlan:
`grep "useActivePlan" emrun-frontend/app/\(tabs\)/plans.tsx`

Check mock generation removed:
`grep -c "Math.random" emrun-frontend/app/\(tabs\)/plans.tsx` should return 0

Run TypeScript check:
`cd emrun-frontend && npx tsc --noEmit`
  </verify>
  <done>
plans.tsx displays real API data from useActivePlan hook.
Loading state shows while fetching.
Empty state shows when no plan exists.
Generating state shows when plan is being created.
Week status calculated from actual dates.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire week and day detail screens to real data</name>
  <files>
    emrun-frontend/app/(plans)/week/[weekNumber].tsx
    emrun-frontend/app/(plans)/day/[dayId].tsx
  </files>
  <action>
1. Update week/[weekNumber].tsx:

Add imports:
```typescript
import { useActivePlan } from '@/src/hooks/usePlan';
import { PlanWeek, PlanDay } from '@/types/plan';
import { ActivityIndicator } from 'react-native';
```

Replace mock data generation with plan data:
```typescript
const { plan, loading } = useActivePlan();
const weekNum = parseInt(weekNumber || '1', 10);

if (loading) {
  return (
    <View style={[styles.container, { justifyContent: 'center', alignItems: 'center' }]}>
      <ActivityIndicator size="large" color={colors.accent.blue} />
    </View>
  );
}

if (!plan?.content?.weeks) {
  return (
    <View style={[styles.container, { justifyContent: 'center', alignItems: 'center' }]}>
      <Text style={{ color: colors.text.secondary }}>Plan non disponible</Text>
    </View>
  );
}

const currentWeek = plan.content.weeks.find(w => w.week_number === weekNum);
if (!currentWeek) {
  return (
    <View style={[styles.container, { justifyContent: 'center', alignItems: 'center' }]}>
      <Text style={{ color: colors.text.secondary }}>Semaine non trouvee</Text>
    </View>
  );
}

const totalWeeks = plan.content.weeks.length;
```

Map days from currentWeek.days:
```typescript
const weekDays = currentWeek.days.map((day, index) => ({
  dayIndex: index,
  dayName: day.day_name.substring(0, 3), // Lun, Mar, etc.
  dayNumber: parseInt(day.date.split('-')[2]),
  isRest: day.is_rest,
  workout: day.workout ? {
    title: day.workout.title,
    duration: `${day.workout.duration_minutes} min`,
    description: day.workout.description,
    icon: getWorkoutIcon(day.workout.type),
  } : undefined,
}));
```

Add helper for workout icons:
```typescript
const getWorkoutIcon = (type: string): string => {
  const icons: Record<string, string> = {
    endurance: 'heart',
    vma: 'timer',
    seuil: 'speedometer',
    fractionne: 'flash',
    recuperation: 'refresh',
    sortie_longue: 'trail-sign',
  };
  return icons[type] || 'fitness';
};
```

Remove WORKOUT_TEMPLATES and generateWeekDays mock function.

2. Update day/[dayId].tsx (if it exists) or create it:

Parse dayId to get week and day:
```typescript
const { dayId } = useLocalSearchParams<{ dayId: string }>();
const [weekNum, dayNum] = (dayId || '1-1').split('-').map(Number);
```

Get day data from plan:
```typescript
const { plan, loading } = useActivePlan();

const currentWeek = plan?.content?.weeks?.find(w => w.week_number === weekNum);
const currentDay = currentWeek?.days?.find(d => parseInt(d.date.split('-')[2]) === dayNum);
```

Display workout details with steps:
```typescript
if (!currentDay?.workout) {
  return <RestDayScreen />; // Show rest day message
}

const workout = currentDay.workout;
// Display workout.title, workout.description, workout.steps
```

Show workout steps as a list:
```typescript
{workout.steps.map((step, index) => (
  <View key={index} style={styles.stepCard}>
    <Text style={styles.stepNumber}>{index + 1}</Text>
    <View style={styles.stepContent}>
      <Text style={styles.stepTitle}>{step.title}</Text>
      <Text style={styles.stepDescription}>{step.description}</Text>
      {step.duration_minutes && (
        <Text style={styles.stepDuration}>{step.duration_minutes} min</Text>
      )}
    </View>
  </View>
))}
```
  </action>
  <verify>
Check week screen uses API:
`grep "useActivePlan" "emrun-frontend/app/(plans)/week/[weekNumber].tsx"`

Check mock data removed:
`grep -c "WORKOUT_TEMPLATES" "emrun-frontend/app/(plans)/week/[weekNumber].tsx"` should return 0

Run full TypeScript check:
`cd emrun-frontend && npx tsc --noEmit`
  </verify>
  <done>
week/[weekNumber].tsx displays real week data from plan.content.weeks.
day/[dayId].tsx displays workout details with steps.
Mock data completely removed from plan screens.
Loading states show during data fetch.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete plan display flow with real API data</what-built>
  <how-to-verify>
1. Start backend: `cd emrun-backend && php artisan serve`
2. Start frontend: `cd emrun-frontend && npx expo start`
3. Log in with a subscribed user
4. Navigate to "Mes Plans" tab
5. Verify you see:
   - Loading state briefly, then either:
   - Empty state if no plan exists, OR
   - Generating state if plan is pending, OR
   - Week cards with real dates and workout counts
6. Tap a week to view daily workouts
7. Tap a workout day to view workout details with steps
8. Verify all text is in French
  </how-to-verify>
  <resume-signal>Type "approved" if plan display works correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd emrun-frontend && npx tsc --noEmit` passes
2. Plan service exists: plan.service.ts exports getActivePlan, getAllPlans
3. usePlan hook exists: usePlan.ts exports useActivePlan, usePlanHistory
4. plans.tsx uses real data: grep shows useActivePlan import, no Math.random
5. week screen uses real data: grep shows useActivePlan, no WORKOUT_TEMPLATES
6. All French: No English strings visible in plan display
</verification>

<success_criteria>
- types/plan.ts matches backend JSON schema
- plan.service.ts provides all plan API functions
- usePlan.ts hook manages loading, error, and data states
- plans.tsx shows real weeks from API with proper loading/empty/generating states
- week/[weekNumber].tsx shows real daily workouts from API
- day/[dayId].tsx shows workout steps from API
- All mock data generation code removed
- User confirms plan display works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-ai-plan-delivery/02-03-SUMMARY.md`
</output>
