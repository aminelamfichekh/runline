---
phase: 02-ai-plan-delivery
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - emrun-backend/app/Services/NotificationService.php
  - emrun-backend/app/Http/Controllers/Api/DeviceController.php
  - emrun-backend/config/services.php
  - emrun-frontend/package.json
  - emrun-frontend/src/services/notification.service.ts
  - emrun-frontend/app/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "User receives push notification when plan is ready"
    - "App registers Expo push token on startup"
    - "Backend sends notifications via Expo Push Service"
  artifacts:
    - path: "emrun-backend/app/Services/NotificationService.php"
      provides: "Expo push notification sending"
      contains: "exp.host"
    - path: "emrun-frontend/src/services/notification.service.ts"
      provides: "Push token registration"
      contains: "getExpoPushTokenAsync"
    - path: "emrun-frontend/app/_layout.tsx"
      provides: "Auto-register push token on auth"
      contains: "registerForPushNotifications"
  key_links:
    - from: "NotificationService.php"
      to: "Expo Push API"
      via: "HTTP POST to exp.host"
      pattern: "exp\\.host.*api.*push"
    - from: "_layout.tsx"
      to: "/api/device/register"
      via: "registerDeviceToken on login"
      pattern: "registerDeviceToken"
---

<objective>
Replace Firebase FCM with Expo Push Notifications for simpler React Native integration.

Purpose: Enable push notifications for plan-ready alerts using Expo's native push service.
Output: Working push notification flow from backend to app when plans are generated.
</objective>

<execution_context>
@C:\Users\dell\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dell\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ai-plan-delivery/02-RESEARCH.md
@emrun-backend/app/Services/NotificationService.php
@emrun-backend/app/Http/Controllers/Api/DeviceController.php
@emrun-frontend/app/_layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update NotificationService to use Expo Push</name>
  <files>
    emrun-backend/app/Services/NotificationService.php
    emrun-backend/config/services.php
  </files>
  <action>
Replace Firebase FCM with Expo Push Service in NotificationService.php:

1. Update sendToDevice() method to use Expo Push API:
```php
private function sendToDevice(string $token, string $title, string $body, ?array $data = null): void
{
    // Skip if not an Expo push token
    if (!str_starts_with($token, 'ExponentPushToken[')) {
        Log::warning('Invalid Expo push token format', ['token' => substr($token, 0, 20)]);
        return;
    }

    $payload = [
        'to' => $token,
        'title' => $title,
        'body' => $body,
        'sound' => 'default',
    ];

    if ($data) {
        $payload['data'] = $data;
    }

    $response = Http::post('https://exp.host/--/api/v2/push/send', $payload);

    if (!$response->successful()) {
        throw new \Exception('Expo push failed: ' . $response->body());
    }

    $responseData = $response->json();

    // Check for push ticket errors
    if (isset($responseData['data']['status']) && $responseData['data']['status'] === 'error') {
        $error = $responseData['data']['message'] ?? 'Unknown error';

        // Mark token as inactive if device not registered
        if (str_contains($error, 'DeviceNotRegistered')) {
            throw new \Exception('DeviceNotRegistered: token invalid');
        }

        throw new \Exception('Expo push error: ' . $error);
    }
}
```

2. Remove Firebase server key references from config/services.php (optional - can leave as fallback)

3. Keep all existing notification methods (notifyPlanGenerated, notifySubscriptionRenewed, etc.) - they use sendNotification() which calls sendToDevice()

The token format check ensures we only try to send to Expo tokens, not legacy FCM tokens.
  </action>
  <verify>
Check the sendToDevice method uses Expo:
`grep -n "exp.host" emrun-backend/app/Services/NotificationService.php`

Check no syntax errors:
`php -l emrun-backend/app/Services/NotificationService.php`
  </verify>
  <done>
NotificationService sends push notifications via Expo Push API.
Invalid token format is detected and logged.
DeviceNotRegistered errors mark tokens as inactive.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create frontend push notification service and registration</name>
  <files>
    emrun-frontend/package.json
    emrun-frontend/src/services/notification.service.ts
    emrun-frontend/app/_layout.tsx
  </files>
  <action>
1. Install expo-notifications package:
Run: `cd emrun-frontend && npx expo install expo-notifications expo-device expo-constants`

2. Create notification.service.ts:
```typescript
import * as Notifications from 'expo-notifications';
import * as Device from 'expo-device';
import Constants from 'expo-constants';
import { Platform } from 'react-native';
import { apiClient } from '@/lib/api/client';

// Configure notification handler
Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowAlert: true,
    shouldPlaySound: true,
    shouldSetBadge: true,
    shouldShowBanner: true,
    shouldShowList: true,
  }),
});

export async function registerForPushNotifications(): Promise<string | null> {
  // Only works on physical devices
  if (!Device.isDevice) {
    console.log('Push notifications require a physical device');
    return null;
  }

  // Request permission
  const { status: existingStatus } = await Notifications.getPermissionsAsync();
  let finalStatus = existingStatus;

  if (existingStatus !== 'granted') {
    const { status } = await Notifications.requestPermissionsAsync();
    finalStatus = status;
  }

  if (finalStatus !== 'granted') {
    console.log('Push notification permission denied');
    return null;
  }

  // Get Expo push token
  try {
    const projectId = Constants.expoConfig?.extra?.eas?.projectId;
    const token = await Notifications.getExpoPushTokenAsync({
      projectId,
    });

    return token.data;
  } catch (error) {
    console.error('Failed to get push token:', error);
    return null;
  }
}

export async function registerDeviceToken(token: string): Promise<void> {
  try {
    await apiClient.post('/device/register', {
      token,
      platform: Platform.OS,
    });
    console.log('Device token registered with backend');
  } catch (error) {
    console.error('Failed to register device token:', error);
  }
}

export async function unregisterDeviceToken(token: string): Promise<void> {
  try {
    await apiClient.post('/device/unregister', { token });
    console.log('Device token unregistered');
  } catch (error) {
    console.error('Failed to unregister device token:', error);
  }
}
```

3. Update app/_layout.tsx to register push token when user is authenticated:

Add imports:
```typescript
import { registerForPushNotifications, registerDeviceToken } from '@/src/services/notification.service';
```

Add useEffect in RootLayoutNav (after auth check):
```typescript
useEffect(() => {
  async function setupPushNotifications() {
    if (isAuthenticated && user) {
      const token = await registerForPushNotifications();
      if (token) {
        await registerDeviceToken(token);
      }
    }
  }
  setupPushNotifications();
}, [isAuthenticated, user]);
```

This registers the push token automatically when the user logs in.
  </action>
  <verify>
Check package.json has expo-notifications:
`grep "expo-notifications" emrun-frontend/package.json`

Check notification service exists:
`ls emrun-frontend/src/services/notification.service.ts`

Check _layout.tsx imports the service:
`grep "registerForPushNotifications" emrun-frontend/app/_layout.tsx`
  </verify>
  <done>
expo-notifications installed with expo-device and expo-constants.
notification.service.ts provides registerForPushNotifications and registerDeviceToken.
_layout.tsx automatically registers push token on user authentication.
  </done>
</task>

</tasks>

<verification>
1. Backend Expo integration: `grep -n "exp.host" emrun-backend/app/Services/NotificationService.php` returns match
2. Frontend packages: `cd emrun-frontend && npm ls expo-notifications` shows installed
3. Notification service: notification.service.ts exists with getExpoPushTokenAsync
4. Auto-registration: _layout.tsx calls registerForPushNotifications on auth
5. PHP syntax: `php -l emrun-backend/app/Services/NotificationService.php` passes
</verification>

<success_criteria>
- NotificationService.php uses Expo Push API (exp.host endpoint)
- expo-notifications, expo-device, expo-constants in frontend package.json
- notification.service.ts exports registerForPushNotifications function
- _layout.tsx registers push token when user authenticates
- Backend handles DeviceNotRegistered errors by marking tokens inactive
</success_criteria>

<output>
After completion, create `.planning/phases/02-ai-plan-delivery/02-02-SUMMARY.md`
</output>
